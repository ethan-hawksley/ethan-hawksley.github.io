---
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';

interface Props {
  pageTitle: string;
  pageDescription: string;
  highlightedLink?: 'home' | 'blog';
  jsonLd?: Record<string, any>;
  robots?: string;
  ogType?: 'website' | 'article' | 'profile';
  article?: { publishedTime: string; modifiedTime?: string; tags: string[] };
}

const {
  pageTitle,
  pageDescription,
  highlightedLink,
  jsonLd,
  robots = 'index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1',
  ogType = 'website',
  article,
} = Astro.props;

const canonicalUrl = new URL(Astro.url.pathname, Astro.site);
---

<html lang="en-GB">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <meta name="author" content="Ethan Hawksley" />
    <meta name="generator" content={Astro.generator} />

    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang="en-GB" href={canonicalUrl} />
    <link rel="alternate" hreflang="x-default" href={canonicalUrl} />
    <meta name="robots" content={robots} />
    <link rel="sitemap" href="/sitemap-index.xml" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="Ethan Hawksley's Blog"
      href="/rss.xml"
    />

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <meta name="color-scheme" content="light dark" />
    <meta
      name="theme-color"
      content="#fafafa"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#0f0f0f"
      media="(prefers-color-scheme: dark)"
    />

    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:site_name" content="Ethan Hawksley" />
    <meta property="og:locale" content="en_GB" />
    <meta
      property="og:image"
      content="https://hawksley.dev/og-image-1200x630.png"
    />
    <meta property="og:image:alt" content={pageTitle} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:type" content="image/png" />

    {
      ogType === 'profile' && (
        <>
          <meta property="profile:first_name" content="Ethan" />
          <meta property="profile:last_name" content="Hawksley" />
          <meta property="profile:username" content="ethan-hawksley" />
        </>
      )
    }

    <meta name="fediverse:creator" content="@ethanhawksley@mastodon.social" />

    {
      article && (
        <>
          <meta
            property="article:published_time"
            content={article.publishedTime}
          />
          <meta
            property="article:modified_time"
            content={article.modifiedTime ?? article.publishedTime}
          />
          <meta property="article:author" content="https://hawksley.dev/" />
          {article.tags.map((tag) => (
            <meta property="article:tag" content={tag} />
          ))}
        </>
      )
    }

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@Ethan_Hawksley" />
    <meta name="twitter:creator" content="@Ethan_Hawksley" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta
      name="twitter:image"
      content="https://hawksley.dev/og-image-1200x630.png"
    />
    <meta name="twitter:image:alt" content={pageTitle} />

    <link
      rel="preload"
      href="/fonts/InterVariable.woff2"
      as="font"
      type="font/woff2"
      crossorigin="anonymous"
      fetchpriority="high"
    />
    {
      Astro.url.pathname.startsWith('/blog/') &&
        Astro.url.pathname !== '/blog/' && (
          <link
            rel="preload"
            href="/fonts/JetBrainsMono.woff2"
            as="font"
            type="font/woff2"
            crossorigin="anonymous"
          />
        )
    }

    <script is:inline>
      function getCurrentTheme() {
        const localTheme = localStorage.getItem('theme');
        if (localTheme) {
          return localTheme;
        }
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          return 'dark';
        }
        return 'light';
      }
      let theme = getCurrentTheme();
      document.documentElement.classList.toggle('dark', theme === 'dark');
      const themeColorMetaTags = document.querySelectorAll(
        'meta[name="theme-color"]',
      );
      const newColor = theme === 'dark' ? '#0f0f0f' : '#fafafa';
      themeColorMetaTags.forEach((tag) =>
        tag.setAttribute('content', newColor),
      );
    </script>

    {
      jsonLd && (
        <script
          type="application/ld+json"
          is:inline
          set:html={JSON.stringify(jsonLd)}
        />
      )
    }

    {Astro.url.pathname !== '/' && <link rel="prefetch" href="/" />}
    {Astro.url.pathname !== '/blog/' && <link rel="prefetch" href="/blog/" />}
    <script is:inline type="speculationrules">
      {
        "prerender": [
          {
            "where": {
              "and": [
                { "href_matches": "/*" },
                { "not": { "href_matches": "/rss.xml" } }
              ]
            },
            "eagerness": "moderate"
          }
        ]
      }
    </script>
  </head>
  <body>
    <a href="#main-content" class="skip-link">Skip to content</a>
    <div id="page">
      <div id="nav-bar">
        <Navigation highlightedLink={highlightedLink} />
      </div>
      <main id="main-content">
        <slot />
      </main>
      <Footer />
    </div>
    <script>
      requestAnimationFrame(() => {
        document.documentElement.classList.add('enable-transitions');
      });
    </script>
  </body>
</html>

<style is:global>
  :root {
    --color-background: #fafafa;
    --color-surface: #f0f0f0;
    --color-text: #1a1a1a;
    --color-text-muted: #525252;
    --color-accent: #d14100;
    --color-border: #e0e0e0;

    --font-size-xs: 0.75rem;
    --font-size-sm: 0.875rem;
    --font-size-base: clamp(1rem, 0.956rem + 0.22vw, 1.125rem);
    --font-size-md: clamp(1.125rem, 1.069rem + 0.28vw, 1.25rem);
    --font-size-lg: clamp(1.25rem, 1.159rem + 0.45vw, 1.5rem);
    --font-size-xl: clamp(1.5rem, 1.341rem + 0.8vw, 1.944rem);
    --font-size-2xl: clamp(1.75rem, 1.506rem + 1.22vw, 2.431rem);
    --font-size-3xl: clamp(2rem, 1.614rem + 1.93vw, 3.038rem);

    --line-height-tight: 1.2;
    --line-height-snug: 1.35;
    --line-height-normal: 1.6;
    --line-height-relaxed: 1.75;

    --letter-spacing-tighter: -0.025em;
    --letter-spacing-tight: -0.015em;
    --letter-spacing-normal: -0.011em;
    --letter-spacing-wide: 0.02em;

    --font-weight-light: 300;
    --font-weight-normal: 400;
    --font-weight-medium: 500;
    --font-weight-semibold: 600;
    --font-weight-bold: 700;
  }

  :root.dark {
    --color-background: #0f0f0f;
    --color-surface: #1a1a1a;
    --color-text: #ededed;
    --color-text-muted: #b0b0b0;
    --color-accent: #ff4f00;
    --color-border: #2a2a2a;
  }

  @property --color-background {
    syntax: '<color>';
    inherits: true;
    initial-value: #fafafa;
  }

  @property --color-surface {
    syntax: '<color>';
    inherits: true;
    initial-value: #f0f0f0;
  }

  @property --color-text {
    syntax: '<color>';
    inherits: true;
    initial-value: #1a1a1a;
  }

  @property --color-text-muted {
    syntax: '<color>';
    inherits: true;
    initial-value: #525252;
  }

  @property --color-accent {
    syntax: '<color>';
    inherits: true;
    initial-value: #d14100;
  }

  @property --color-border {
    syntax: '<color>';
    inherits: true;
    initial-value: #e0e0e0;
  }

  @font-face {
    font-family: 'Inter';
    font-style: normal;
    font-weight: 100 900;
    font-display: swap;
    src: url('/fonts/InterVariable.woff2') format('woff2');
  }

  @font-face {
    font-family: 'JetBrains Mono';
    font-style: normal;
    font-weight: 100 900;
    font-display: swap;
    src: url('/fonts/JetBrainsMono.woff2') format('woff2');
  }

  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }

  *:not(dialog) {
    margin: 0;
  }

  html {
    background-color: var(--color-background);
    color: var(--color-text);
    font-family:
      'Inter',
      system-ui,
      -apple-system,
      BlinkMacSystemFont,
      'Segoe UI',
      Roboto,
      Oxygen,
      Ubuntu,
      Cantarell,
      'Open Sans',
      'Helvetica Neue',
      sans-serif;
    font-feature-settings:
      'kern' 1,
      'liga' 1,
      'calt' 1,
      'ss01' 1,
      'cv05' 1;
    font-kerning: normal;
    font-optical-sizing: auto;
    color-scheme: light dark;
    accent-color: var(--color-accent);
    scroll-behavior: smooth;
    scrollbar-gutter: stable;
    scrollbar-color: var(--color-text-muted) var(--color-background);
  }

  html.enable-transitions {
    transition:
      --color-background 250ms ease-out,
      --color-surface 250ms ease-out,
      --color-text 250ms ease-out,
      --color-text-muted 250ms ease-out,
      --color-accent 250ms ease-out,
      --color-border 250ms ease-out;
  }

  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
    }

    html {
      scroll-behavior: auto;
    }

    html.enable-transitions {
      transition-duration: 0.01ms !important;
    }
  }

  @media (prefers-reduced-motion: no-preference) {
    html {
      interpolate-size: allow-keywords;
    }
  }

  body {
    font-size: var(--font-size-base);
    line-height: var(--line-height-normal);
    font-weight: var(--font-weight-normal);
    letter-spacing: var(--letter-spacing-normal);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    text-wrap: balance;
    text-rendering: optimizeLegibility;
    font-weight: var(--font-weight-semibold);
    font-variant-ligatures: common-ligatures;
    font-feature-settings:
      'kern' 1,
      'liga' 1,
      'ss01' 0;
  }

  p,
  h1,
  h2,
  h3,
  h4,
  h5,
  h6 {
    overflow-wrap: break-word;
  }

  h1 {
    font-size: var(--font-size-3xl);
    line-height: var(--line-height-tight);
    letter-spacing: var(--letter-spacing-tighter);
    font-weight: var(--font-weight-bold);
  }

  h2 {
    font-size: var(--font-size-2xl);
    line-height: var(--line-height-tight);
    letter-spacing: var(--letter-spacing-tight);
  }

  h3 {
    font-size: var(--font-size-xl);
    line-height: var(--line-height-snug);
    letter-spacing: var(--letter-spacing-tight);
  }

  h4 {
    font-size: var(--font-size-lg);
    line-height: var(--line-height-snug);
    letter-spacing: var(--letter-spacing-normal);
    font-weight: var(--font-weight-medium);
  }

  p {
    text-wrap: pretty;
  }

  p,
  li {
    hanging-punctuation: first allow-end last;
  }

  small {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    letter-spacing: var(--letter-spacing-normal);
    line-height: var(--line-height-normal);
  }

  img,
  picture,
  video,
  canvas,
  svg {
    display: block;
    max-width: 100%;
    height: auto;
  }

  input,
  button,
  textarea,
  select {
    font: inherit;
  }

  a,
  button {
    touch-action: manipulation;
  }

  a svg,
  button svg {
    pointer-events: none;
  }

  button {
    transition: transform 0.1s ease-out;
  }

  button:active {
    transform: scale(0.96);
  }

  :focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 4px;
    border-radius: 2px;
  }

  ::selection {
    background-color: var(--color-accent);
    color: #fff;
  }

  ::-webkit-scrollbar {
    width: 10px;
  }

  ::-webkit-scrollbar-track {
    background: var(--color-background);
  }

  ::-webkit-scrollbar-thumb {
    background-color: var(--color-border);
    border-radius: 10px;
    border: 2px solid var(--color-background);
  }

  ::-webkit-scrollbar-thumb:hover {
    background-color: var(--color-text-muted);
  }
</style>

<style>
  #page {
    max-width: 768px;
    margin-inline: auto;
    padding-top: 1rem;
    padding-bottom: 1.5rem;
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
  }

  .skip-link {
    position: absolute;
    top: -100%;
    left: 1rem;
    padding: 0.5rem 1rem;
    background: var(--color-accent);
    color: #fff;
    border-radius: 0.25rem;
    z-index: 9999;
    text-decoration: none;
  }

  .skip-link:focus {
    top: 1rem;
  }

  #nav-bar {
    margin-bottom: 1.5rem;
  }

  main {
    max-width: 900px;
    margin-inline: auto;
    padding-inline: 1.5rem;
    width: 100%;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }
</style>
